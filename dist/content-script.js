const S="[EnergyTracker-CS]";function c(...t){try{console.log(S,...t)}catch{}}function p(t){if(!t)return 0;const e=String(t).trim();return e?Math.ceil(e.length/4):0}function E(t=""){const e=t.toLowerCase();return e.includes("o1")||e.includes("gpt-4")||e.includes("4o")?"large":e.includes("mini")||e.includes("3.5")||e.includes("gpt-3")?"small":"medium"}const g={small:{energyWh:.8,waterL:.4,co2g:5},medium:{energyWh:1.2,waterL:.6,co2g:8},large:{energyWh:1.8,waterL:.9,co2g:12}};function L(t,e){const o=E(e),n=g[o]||g.medium,a=t/1e3,r=n.energyWh*a,s=n.waterL*a,i=n.co2g*a;return{tokens:t,energyWh:r,energyKWh:r/1e3,waterL:s,co2g:i}}const m="usageStats";function l(){return{total:{tokens:0,energyWh:0,waterL:0,co2g:0,queries:0},conversations:{},lastQuery:null}}function T(){return new Promise(t=>{var e;try{if(!((e=chrome==null?void 0:chrome.storage)!=null&&e.local)){t(l());return}chrome.storage.local.get([m],o=>{if(chrome.runtime.lastError){c("loadStats error",chrome.runtime.lastError),t(l());return}t(o[m]||l())})}catch(o){c("loadStats exception",o),t(l())}})}function W(t){return new Promise(e=>{var o;try{if(!((o=chrome==null?void 0:chrome.storage)!=null&&o.local)){e();return}chrome.storage.local.set({[m]:t},()=>{chrome.runtime.lastError&&c("saveStats error",chrome.runtime.lastError),e()})}catch(n){c("saveStats exception",n),e()}})}function k(){try{const e=(window.location.pathname||"").split("/").filter(Boolean);return e[e.length-1]||"default"}catch{return"default"}}function M(){try{const t=document.querySelector('[data-testid="model-switcher"]')||document.querySelector('button[aria-label*="Model"]');if(t&&t.textContent)return t.textContent.trim();const e=document.querySelector('[data-testid*="model"], [class*="model"]');if(e&&e.textContent)return e.textContent.trim()}catch(t){c("model detection error",t)}return"ChatGPT"}function d(t){return t&&(t.innerText||t.textContent)||""}async function v(t){const e=(t||"").trim();if(!e){c("trackUserMessage: empty text, skipping");return}const o=M(),n=p(e),a=k(),r=L(n,o);let s=await T();(!s||!s.total)&&(s=l()),s.total.tokens+=r.tokens,s.total.energyWh+=r.energyWh,s.total.waterL+=r.waterL,s.total.co2g+=r.co2g,s.total.queries+=1;const i=a||"unknown";s.conversations[i]||(s.conversations[i]={tokens:0,energyWh:0,waterL:0,co2g:0,queries:0});const u=s.conversations[i];u.tokens+=r.tokens,u.energyWh+=r.energyWh,u.waterL+=r.waterL,u.co2g+=r.co2g,u.queries+=1,s.lastQuery={conversationId:i,model:o,tokens:r.tokens,energyWh:r.energyWh,energyKWh:r.energyKWh,waterL:r.waterL,co2g:r.co2g,timestamp:Date.now()},c("trackUserMessage: updated stats",s),await W(s);try{chrome.runtime.sendMessage({type:"USAGE_STATS_UPDATED",stats:s})}catch(w){c("sendMessage USAGE_STATS_UPDATED error",w)}}const h=new Set;function f(t){var a,r;if(!(t instanceof HTMLElement))return;let e=t;if((a=e.matches)!=null&&a.call(e,'[data-message-author-role="user"]')||(e=((r=t.querySelector)==null?void 0:r.call(t,'[data-message-author-role="user"]'))||null),!e)return;const o=e.getAttribute("data-message-id")||d(e).slice(0,100);if(!o||h.has(o))return;h.add(o);const n=d(e);n.trim()&&(c("detected new user message",{id:o,preview:n.slice(0,80)+"â€¦"}),v(n))}function y(){document.querySelectorAll('[data-message-author-role="user"]').forEach(e=>f(e))}const x=new MutationObserver(t=>{let e=!1;for(const o of t)o.addedNodes&&o.addedNodes.forEach(n=>{var a,r;n instanceof HTMLElement&&((a=n.matches)!=null&&a.call(n,'[data-message-author-role="user"]')||(r=n.querySelector)!=null&&r.call(n,'[data-message-author-role="user"]'))&&(e=!0,f(n))});e||y()});try{x.observe(document.documentElement||document.body,{childList:!0,subtree:!0}),c("content script loaded, observer attached"),y()}catch(t){c("observer setup error",t)}
